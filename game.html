<!doctype html> 
<html lang="en"> 
<head> 
  <meta charset="UTF-8" />
  <title>Phaser Game</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <link rel="stylesheet" type="text/css" href="assets/cat-game.css">
    <link href='http://fonts.googleapis.com/css?family=Sniglet' rel='stylesheet' type='text/css'>
</head>
<body>

<h1>HAPPY CAT</h1>

<script>

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

var playerSpeed = 0;

var itemSpeed = -125;

function preload() {
  game.load.image('background', 'assets/background.png');
  game.load.image('yarn', 'assets/yarn.png');
  game.load.image('mouse', 'assets/mouse.png');
  game.load.image('zed', 'assets/sleep.png');
  game.load.image('plus', 'assets/plus.png');
  game.load.image('life', 'assets/life.png');
  game.load.image('death', 'assets/death.png');
  game.load.image('minus', 'assets/minus.png');
  game.load.image('cat', 'assets/cat.png');
  game.load.image('pause', 'assets/pause.png');
  game.load.image('play', 'assets/play.png');
}

function create() {
  game.physics.startSystem(Phaser.Physics.ARCADE);

  game.add.sprite(0, 0, 'background');

  // PLAYER
  player = game.add.sprite(370, 50, 'cat');

  game.physics.arcade.enable(player);

  player.body.collideWorldBounds = true;

  player.animations.add('left');
  player.animations.add('right');

  cursors = game.input.keyboard.createCursorKeys();

  // YARN
  ballsOfYarn = game.add.group();

  ballsOfYarn.enableBody = true;

  // MOUSE
  mice = game.add.group();

  mice.enableBody = true;

  // ZED / SLEEP
  zeds = game.add.group();

  zeds.enableBody = true;

  // PLUS SIGN
  plusSigns = game.add.group();

  plusSigns.enableBody = true;

  // MINUS SIGN
  minusSigns = game.add.group();

  minusSigns.enableBody = true;

  // LIFE
  lives = game.add.group();

  lives.enableBody = true;

  // DEATH
  deaths = game.add.group();

  deaths.enableBody = true;

  score = 0;

  scoreText = game.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#000' });

  game.time.events.loop(Phaser.Timer.SECOND * 0.35, addItem, this);

  playerLives = 9;

  playerLivesText = game.add.text(600, 16, 'Lives: 9', { fontSize: '32px', fill: '#000' });

  pauseButton = game.add.button(800 - 54, 25, 'pause', pauseGame, this);
  playButton = game.add.button(800 - 34, 25, 'play', playGame, this);

}

function pauseGame() {
  game.lockRender = true;
  game.input.keyboard.removeKey(Phaser.Keyboard.LEFT);
  game.input.keyboard.removeKey(Phaser.Keyboard.RIGHT);
}

function playGame() {
  game.lockRender = false;
  // game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
  // game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
  cursors = game.input.keyboard.createCursorKeys();
}

function addItem(){

  // TODO group of groups 

  num = Math.random();

  items = [[ballsOfYarn, 'yarn'], [mice, 'mouse'], [zeds, 'zed']];

  lifeOrDeath = [[lives, 'life'], [deaths, 'death']];

  speeds = [[plusSigns, 'plus'], [minusSigns, 'minus']];

  if (num < 0.1) {
    type = lifeOrDeath[0];
  }
  else if (num < 0.4) {
    type = lifeOrDeath[1];
  }
  else if (num < 0.8) {
    type = items[Math.floor(Math.random()*items.length)];
  }
  else {
    type = speeds[Math.floor(Math.random()*speeds.length)];
  }

  var item = type[0].create(rand_interval(), 600, type[1]);
  // 25 + (Math.random() * 750

  item.body.velocity.y = itemSpeed;

  item.events.onOutOfBounds.add(destroyItem, this);
}

function rand_interval() {
  return Math.round((Math.random()*(775-25)+25)/50)*50;
}

function destroyItem(yarn) {
  yarn.destroy();
}

function update() {
  player.body.velocity.x = 0;

  if (cursors.left.isDown)
  {
    player.body.velocity.x = (-200 - playerSpeed);

    player.animations.play('left');
  }
  else if (cursors.right.isDown)
  {
    player.body.velocity.x = (200 + playerSpeed);

    player.animations.play('right');
  }
  else
  {
    player.animations.stop();
  }

  game.physics.arcade.overlap(player, ballsOfYarn, collectYarn, null, this);

  game.physics.arcade.overlap(player, mice, collectMouse, null, this);

  game.physics.arcade.overlap(player, zeds, collectZed, null, this);

  game.physics.arcade.overlap(player, plusSigns, increasePlayerSpeed, null, this);

  game.physics.arcade.overlap(player, minusSigns, decreasePlayerSpeed, null, this);

  game.physics.arcade.overlap(player, lives, addALife, null, this);

  game.physics.arcade.overlap(player, deaths, loseALife, null, this);

  function collectYarn (player, yarn) {
    yarn.destroy();

    addToScore(100);
  }

  function collectMouse (player, mouse) {
    mouse.destroy();

    addToScore(200);
  }

  function collectZed (player, zed) {
    zed.destroy();

    addToScore(500);
  }

  function addToScore (points) {
    score += points;
    scoreText.text = 'Score: ' + score;
  }


  // TODO refactor into one function

  function increasePlayerSpeed (player, plus) {
    plus.destroy();

    if (playerSpeed > 10 && playerSpeed < 100) 
    { 
      playerSpeed += 10;    
    }
  }

  function decreasePlayerSpeed (player, minus) {
    minus.destroy();

    if (playerSpeed > 10 && playerSpeed < 100) 
    { 
      playerSpeed -= 10;
    }

  }

  function addALife (player, life) {

    life.destroy();

    if (playerLives < 9)
    {
      playerLives += 1;
      playerLivesText.text = 'Lives: ' + playerLives;
    }
  }

  function loseALife (player, death) {

    death.destroy();

    if (playerLives > 0)
    {
      playerLives -= 1;
      playerLivesText.text = 'Lives: ' + playerLives;
    }
  }

  // TODO how do I update score before lockRender?
  if (playerLives == 0)
  {
    game.lockRender = true;

    // make button
    // revive button?

    // if(userClicksRestart()) { 
    //   restartGame();  // Call the restart function
    // }
  }

  function restartGame() {
    game.lockRender = false;
    player.resetPosition();
    score = 0;
    playerSpeed = 0; 
    playerLives = 9;
  }

  if (score > 0 && itemSpeed > -350) 
  {
    itemSpeed = -(125 + score * 0.02);
  }
  
}

// background changes color every hundred points
// highscore

// comments

</script>

<div>
  <table>
    <th colspan="2">Cats have 9 lives. Don't run out!</th>
    <tr>
      <td><img src="assets/life.png"></td>
      <td>Gain a Life!</td>
    </tr>
    <tr>
      <td><img src="assets/death.png"></td>
      <td>Lose a Life!</td>
    </tr>
    <tr>
      <td><img src="assets/plus.png"></td>
      <td>Faster Cat</td>
    </tr>
    <tr>
      <td><img src="assets/minus.png"></td>
      <td>Slower Cat</td>
    </tr>
    <tr>
      <td><img src="assets/yarn.png"></td>
      <td>Yarn is fun.</br>
          Add 100 Points!</td>
    </tr>
    <tr>
      <td><img src="assets/mouse.png"></td>
      <td>Yum, a mouse.</br>
          Add 200 Points!</td>
    </tr>
    <tr>
      <td><img src="assets/sleep.png"></td>
      <td>Cat nap 4 life.</br>
          Add 500 Points.</td>
    </tr>
  </table>
</div>

</body>
</html>