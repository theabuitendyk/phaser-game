<!doctype html> 
<html lang="en"> 
<head> 
  <meta charset="UTF-8" />
  <title>Phaser Game</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

var playerSpeed = 0;

function preload() {
  game.load.image('background', 'assets/background.png');
  game.load.image('yarn', 'assets/yarn.png');
  game.load.image('plus', 'assets/plus.png');
  game.load.image('life', 'assets/life.png');
  game.load.image('death', 'assets/death.png');
  game.load.image('minus', 'assets/minus.png');
  game.load.image('cat', 'assets/cat.png');
}

function create() {
  game.physics.startSystem(Phaser.Physics.ARCADE);

  game.add.sprite(0, 0, 'background');

  // PLAYER
  player = game.add.sprite(370, 50, 'cat');

  game.physics.arcade.enable(player);

  player.body.collideWorldBounds = true;

  player.animations.add('left');
  player.animations.add('right');

  cursors = game.input.keyboard.createCursorKeys();

  // YARN
  ballsOfYarn = game.add.group();

  ballsOfYarn.enableBody = true;

  // PLUS SIGN
  plusSigns = game.add.group();

  plusSigns.enableBody = true;

  // MINUS SIGN
  minusSigns = game.add.group();

  minusSigns.enableBody = true;

  // LIFE
  lives = game.add.group();

  lives.enableBody = true;

  // DEATH
  deaths = game.add.group();

  deaths.enableBody = true;

  game.time.events.loop(Phaser.Timer.SECOND * 2, addItem, this);

  score = 0;

  scoreText = game.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });

  playerLives = 1;

  playerLivesText = game.add.text(600, 16, 'lives: 1', { fontSize: '32px', fill: '#000' });
}

function addItem(){

  items = [[ballsOfYarn, 'yarn'], [plusSigns, 'plus'], [minusSigns, 'minus'], [lives, 'life'], [deaths, 'death']]

  type = items[Math.floor(Math.random()*items.length)];

  var item = type[0].create(Math.random() * 800, 600, type[1]);

  item.body.velocity.y = -100;

  item.events.onOutOfBounds.add(destroyItem, this);
}

function destroyItem(yarn) {
  yarn.destroy();
}

function update() {
  player.body.velocity.x = 0;

  if (cursors.left.isDown)
  {
    player.body.velocity.x = (-150 - playerSpeed);

    player.animations.play('left');
  }
  else if (cursors.right.isDown)
  {
    player.body.velocity.x = (150 + playerSpeed);

    player.animations.play('right');
  }
  else
  {
    player.animations.stop();
  }

  game.physics.arcade.overlap(player, ballsOfYarn, collectYarn, null, this);

  game.physics.arcade.overlap(player, plusSigns, increasePlayerSpeed, null, this);

  game.physics.arcade.overlap(player, minusSigns, decreasePlayerSpeed, null, this);

  game.physics.arcade.overlap(player, lives, addALife, null, this);

  game.physics.arcade.overlap(player, deaths, loseALife, null, this);

  function collectYarn (player, yarn) {
    yarn.destroy();

    score += 10;
    scoreText.text = 'score: ' + score;

  }

  // TODO refactor into one function

  function increasePlayerSpeed (player, plus) {
    plus.destroy();

    playerSpeed += 30;
  }

  function decreasePlayerSpeed (player, minus) {
    minus.destroy();

    if (playerSpeed > 30) 
    { 
      playerSpeed -= 30;
    }

  }

  function addALife (player, life) {

    life.destroy();

    if (playerLives < 9)
    {
      playerLives += 1;
      playerLivesText.text = 'lives: ' + playerLives;
    }
  }

  function loseALife (player, death) {

    death.destroy();

    if (playerLives > 0)
    {
      playerLives -= 1;
      playerLivesText.text = 'lives: ' + playerLives;
    }
  }

  // TODO how do I update score before lockRender?
  if (playerLives == 0)
  {
    game.lockRender = true;

    // make button
    // revive button?

    // if(userClicksRestart()) { 
    //   restartGame();  // Call the restart function
    // }
  }

  function restartGame() {
    game.lockRender = false;
    player.resetPosition();
    score = 0;
    playerSpeed = 0; 
    playerLives = 9;
  }
}

</script>

</body>
</html>